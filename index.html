<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Feld-Mapping Tool</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#f7f8fb; --panel:#ffffff; --card:#ffffff;
      --text:#0f172a; --muted:#6b7280;
      --border:#d9dee8; --border-soft:#e7ebf3;
      --accent:#2563eb; --accent-weak:#eef3ff;
      --ok:#059669; --warn:#b45309; --danger:#b91c1c;
      --radius:14px; --shadow:0 8px 24px rgba(15,23,42,.08);
      --chip:#ffffff; --chip-active:#eef3ff;
      --btn:#ffffff; --btn-border:#d9dee8;
      --focus:0 0 0 3px rgba(37,99,235,.25);
    }
    *{box-sizing:border-box;}
    html,body{margin:0;height:100%;}
    body{
      font:14px/1.55 system-ui,-apple-system,"Segoe UI",Roboto,Tahoma,sans-serif;
      background:var(--bg);color:var(--text);
    }

    .topbar{
      position:sticky;top:0;z-index:20;
      background:var(--panel);
      border-bottom:1px solid var(--border-soft);
      box-shadow:0 2px 6px rgba(0,0,0,.04);
    }
    .topbar-inner{
      max-width:1200px;margin:0 auto;padding:14px 20px;
      display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:16px;
    }
    h1{margin:0;font-size:1.2rem;}

    .search{display:flex;gap:8px;align-items:center;}
    .input{display:flex;align-items:center;gap:6px;
      padding:8px 12px;border:1px solid var(--border);border-radius:12px;
      background:var(--card);}
    .input input{border:0;outline:0;background:transparent;color:inherit;width:220px;}
    .btn{padding:8px 12px;border:1px solid var(--btn-border);background:var(--btn);
      border-radius:10px;cursor:pointer;}
    .btn:focus-visible{outline:none;box-shadow:var(--focus);}

    .container{max-width:1200px;margin:0 auto;padding:22px 20px;}
    .chips{display:flex;gap:8px;flex-wrap:wrap;}
    .chip{padding:.45rem .8rem;border:1px solid var(--border);border-radius:999px;
      background:var(--chip);cursor:pointer;}
    .chip.active{background:var(--chip-active);border-color:var(--accent);color:var(--accent);font-weight:600;}
    .chip:focus-visible{outline:none;box-shadow:var(--focus);}

    .segment{display:inline-flex;border:1px solid var(--border);background:var(--panel);border-radius:999px;}
    .segment button{padding:.5rem 1rem;border:0;background:transparent;cursor:pointer;}
    .segment button.active{background:var(--accent-weak);font-weight:600;color:var(--accent);}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);}
    .sticky-tools{position:sticky;top:60px;z-index:10;background:var(--panel);
      border-bottom:1px solid var(--border-soft);padding:10px 14px;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius);
      display:flex;gap:12px;align-items:center;flex-wrap:wrap;}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:var(--panel);
      border:1px solid var(--border-soft);border-radius:999px;font-weight:600;color:var(--text);}
    .pill .sep{opacity:.6;}
    #mappingDisplay{margin-top:12px;}
    .table-wrap{padding:14px;}
    .status{color:var(--muted);margin-bottom:8px;}
    iframe{width:100%;min-height:420px;border:1px solid var(--border);border-radius:12px;background:var(--card);}
    mark.__hit{background:#ffea8a;padding:0 .08em;}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <h1>Mapping-Tool</h1>
      <form class="search" onsubmit="return false;">
        <div class="input">
          <input id="globalSearchInput" type="search" placeholder="Globale Suche…" autocomplete="off"/>
        </div>
        <button id="clearSearch" class="btn" type="button">Leeren</button>
      </form>
    </div>
  </header>

  <main class="container">
    <div class="chips" id="dataTypes"></div>
    <div class="segment" role="tablist">
      <button id="viewFieldBtn" role="tab" aria-selected="true" class="active" type="button">Feld</button>
      <button id="viewCategoryBtn" role="tab" aria-selected="false" type="button">Kategorie</button>
    </div>
    <section id="mappingDisplay" class="card"></section>
  </main>

  <script>
    const contentLocations={
      POI:{field:"content/poi-fields.html",category:"content/poi-categories.html"},
      Tour:{field:"content/tour-fields.html",category:"content/tour-categories.html"},
      Event:{field:"content/event-fields.html",category:"content/event-categories.html"},
      Gastro:{field:"content/gastro-fields.html",category:"content/gastro-categories.html"},
      Hotel:{field:"content/hotel-fields.html",category:"content/hotel-categories.html"},
      Angebot:{field:"content/angebot-fields.html",category:"content/angebot-categories.html"}
    };
    const dataTypes=Object.keys(contentLocations);
    let selectedDataType=dataTypes[0];let viewMode="field";
    const targetName="SaTourN";

    const $=s=>document.querySelector(s);
    const el=(tag,props={},...kids)=>{const n=document.createElement(tag);
      Object.entries(props).forEach(([k,v])=>{if(k==="class")n.className=v;
        else if(k.startsWith("on"))n.addEventListener(k.slice(2),v);
        else if(k==="attrs")Object.entries(v).forEach(([a,val])=>n.setAttribute(a,val));
        else n[k]=v;});kids.flat().forEach(k=>n.append(k?.nodeType?k:document.createTextNode(k)));return n;};

    function clearMarks(doc){doc?.querySelectorAll('mark.__hit')?.forEach(m=>m.replaceWith(doc.createTextNode(m.textContent))); }
    function highlight(doc,term){
      if(!term)return;
      const rx=new RegExp(term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),'gi');
      const walker=doc.createTreeWalker(doc.body,NodeFilter.SHOW_TEXT,{acceptNode(n){
        if(!n.nodeValue.trim())return NodeFilter.FILTER_REJECT;
        if(!rx.test(n.nodeValue))return NodeFilter.FILTER_REJECT;
        return NodeFilter.FILTER_ACCEPT;}});
      const nodes=[];while(walker.nextNode())nodes.push(walker.currentNode);
      nodes.forEach(node=>{
        const frag=doc.createDocumentFragment();let last=0;
        node.nodeValue.replace(rx,(m,idx)=>{
          frag.append(doc.createTextNode(node.nodeValue.slice(last,idx)));
          const mark=doc.createElement('mark');mark.className='__hit';mark.textContent=m;
          frag.append(mark);last=idx+m.length;return m;});
        frag.append(doc.createTextNode(node.nodeValue.slice(last)));
        node.parentNode.replaceChild(frag,node);
      });
    }
    function applySearchToFrame(){
      const q=$("#globalSearchInput").value.trim();
      const frame=document.querySelector("#mappingDisplay iframe");if(!frame)return;
      try{const doc=frame.contentDocument;if(!doc)return;
        clearMarks(doc);if(q)highlight(doc,q);}catch{}
    }

    function renderTypeChips(){
      const wrap=$("#dataTypes");wrap.innerHTML="";
      dataTypes.forEach(t=>{
        const chip=el("button",{class:"chip"+(selectedDataType===t?" active":""),textContent:t,type:"button",
          onclick:async e=>{selectedDataType=t;wrap.querySelectorAll(".chip").forEach(b=>b.classList.toggle("active",b===e.currentTarget));await renderMapping();}});
        wrap.append(chip);
      });
    }

    async function renderMapping(){
      const container=$("#mappingDisplay");container.innerHTML="";
      const url=contentLocations[selectedDataType]?.[viewMode];if(!url){container.textContent="Kein Mapping";return;}
      const absUrl=new URL(url,location.href).toString();
      const tools=el('div',{class:'sticky-tools'},
        el('div',{class:'pill'},`${selectedDataType} • ${viewMode==='category'?'Kategorien':'Felder'}`),
        el('a',{href:absUrl,target:'_blank',class:'btn',style:'margin-left:auto'},'Öffnen'));
      container.append(tools);
      const wrap=el('div',{class:'table-wrap'});const status=el('div',{class:'status'},`Lade: ${absUrl} …`);
      const frame=el('iframe',{loading:'lazy'});wrap.append(status,frame);container.append(wrap);
      try{
        const res=await fetch(absUrl,{cache:'no-cache'});if(!res.ok)throw new Error();
        let html=await res.text();
        const baseHref=absUrl.replace(/[^/]*$/,'');const baseTag=`<base href="${baseHref}">`;
        if(/<head[^>]*>/i.test(html)){html=html.replace(/<head[^>]*>/i,m=>`${m}\n${baseTag}`);}
        else if(/<html[^>]*>/i.test(html)){html=html.replace(/<html[^>]*>/i,m=>`${m}\n<head>${baseTag}</head>`);}
        else{html=`<head>${baseTag}</head>`+html;}
        frame.srcdoc=html;status.textContent="";
        frame.addEventListener('load',applySearchToFrame);setTimeout(applySearchToFrame,0);
      }catch{status.textContent="Konnte nicht laden.";frame.src=absUrl;}
    }

    $("#viewFieldBtn").addEventListener("click",async()=>{viewMode="field";$("#viewFieldBtn").classList.add("active");$("#viewCategoryBtn").classList.remove("active");await renderMapping();});
    $("#viewCategoryBtn").addEventListener("click",async()=>{viewMode="category";$("#viewCategoryBtn").classList.add("active");$("#viewFieldBtn").classList.remove("active");await renderMapping();});

    const globalInput=$("#globalSearchInput");const clearBtn=$("#clearSearch");
    globalInput.addEventListener("input",()=>{applySearchToFrame();});
    clearBtn.addEventListener("click",()=>{globalInput.value="";applySearchToFrame();});

    (async function init(){renderTypeChips();await renderMapping();})();
  </script>
</body>
</html>
